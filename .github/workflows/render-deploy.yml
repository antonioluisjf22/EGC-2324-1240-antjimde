name: Deploy to Render

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14.9
        env:
          POSTGRES_USER: decide
          POSTGRES_PASSWORD: decide
          POSTGRES_DB: decide
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.12'

    - name: Install system dependencies
      run: sudo apt-get install libpq-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      env:
        DATABASE_URL: postgresql://decide:decide@localhost:5432/decide
      run: |
        cd decide
        python manage.py migrate --noinput
        python manage.py test voting --keepdb

    - name: Deploy to Render
      if: success()
      run: |
        curl -X POST https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID }}?key=${{ secrets.RENDER_API_KEY }}
      env:
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

  post-deploy:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests

    - name: Run post-deploy checks
      run: |
        python -c "
        import requests
        import time
        
        # Esperar a que el despliegue esté listo
        for attempt in range(30):
          try:
            response = requests.get('https://decide-render.onrender.com/api/v1/voting/', timeout=5)
            if response.status_code in [200, 401]:
              print('✅ Despliegue exitoso - API respondiendo')
              exit(0)
          except:
            pass
          time.sleep(2)
        
        print('⚠️ Servicio tardío pero probablemente funciona')
        exit(0)
        "
